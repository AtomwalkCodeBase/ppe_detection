# LabGuard Backend – PPE Detection SystemThis repository contains the backend for **LabGuard**, a PPE (Personal Protective Equipment) detection system designed for laboratory entry control.The backend:- Receives image frames from an on-prem SDK- Runs person + PPE detection using YOLO- Evaluates lab-specific PPE rules- Stores annotated proof images in S3- Exposes APIs for LMS / Mobile UI- Optionally pushes results to Atomwalk---## 1. High-level architectureWorkFlow:1. User clicks **Enter Lab** (Mobile / LMS UI)2. Backend creates an entry request3. SDK polls backend for commands4. SDK captures image and sends it to backend5. Backend:   - Detects person   - Detects PPE   - Evaluates PPE policy   - Annotates image   - Uploads proof to S3   - Stores result6. UI polls backend and displays:   - PPE status (passed / missing)   - Which PPE passed / failed   - Snapshot image---## 2. Folder structure overview```backend/├── app/│   ├── ai/                 AI inference logic│   ├── auth/               SDK authentication│   ├── db/                 Database models and setup│   ├── integrations/       External integrations (Atomwalk)│   ├── lms/                LMS & UI-facing logic│   ├── routes/             SDK-facing APIs│   ├── ui/                 Mobile UI (HTML)│   ├── utils/              Helpers (S3 upload)│   └── main.py             FastAPI app entry├── models/                 YOLO model weights├── requirements.txt└── README.md```---## 3. Core modules explained### 3.1 app/main.py- FastAPI application entry point- Registers all routes- Mounts mobile UI- Health endpoint---### 3.2 AI layer – app/ai/#### ppe_detector.pyResponsible for:- Loading YOLO person model- Loading YOLO PPE model- Detecting a person at the door ROI- Detecting PPE on the person- Mapping class IDs to real PPE names- Drawing bounding boxes and labelsExample output:```json{  "person_detected": true,  "ppe_detected": ["Face Mask", "Protective Clothing"]}```#### decision_engine.pyResponsible for:- Reading lab PPE rules- Normalizing detected PPE- Comparing detected vs required PPE- Producing final decisionExample output:```json{  "status": "PPE_MISSING",  "ppe_status": {    "Face Mask": "PASSED",    "Examination Gloves": "FAILED"  },  "overall": "FAILED"}```---## 4. PPE policy – app/lms/ppe_policy.pyDefines lab-specific PPE rules.Example:```pythonLAB_PPE_RULES = {    "LAB-01": ["mask"],    "LAB-02": ["mask", "gloves"],    "LAB-03": ["mask", "coat"]}```This allows different labs to enforce different PPE requirements without retraining models.---## 5. SDK-facing APIs – app/routes/### sdk_commands.py- SDK polls /sdk/commands- Backend responds with CAPTURE_ENTRY when a user triggers entry### sdk_ingest.py- SDK uploads captured image frames- Backend:  - Runs PPE detection  - Evaluates PPE rules  - Uploads annotated image to S3  - Saves result  - Returns PPE status and snapshot URL---## 6. LMS / UI APIs – app/lms/### trigger.py- Called when user clicks **Enter Lab**- Creates an entry request for SDK### entry_status.py- UI polls to check if processing is complete### entry_result.py- UI fetches:  - PPE status  - Passed / failed PPE details  - Snapshot image URL---## 7. Database layer – app/db/Used for:- Entry lifecycle tracking- SDK command state management- UI polling supportKey files:- models.py- session.py- init_db.py- seed.py- seed_sdk_keys.py---## 8. Authentication – app/auth/### sdk_auth.py- Validates SDK API key- Prevents unauthorized SDK uploads### security.py- Password hashing utilities- Used during user seeding---## 9. External integration – app/integrations/### atomwalk_client.py- Authenticates device with Atomwalk- Uploads PPE status and image- Does not affect core detection flow---## 10. S3 integration – app/utils/snapshot.pyResponsibilities:- Encode annotated image- Upload image to S3- Generate presigned URL- Return URL to UIImages are private and accessed only via time-limited URLs.---## 11. Models – models/Required files:- yolo11n.pt – person detection- best.pt – PPE detectionModels are loaded once at backend startup.---## 12. Requirements```txtfastapiuvicorn[standard]sqlalchemyopencv-python-headlessnumpyultralyticstorchboto3botocorerequestspython-multipart```---## 13. One-time cloud & server setup (AWS)### 13.1 EC2- Ubuntu 20.04 or 22.04- Minimum 2 vCPU, 4 GB RAM- Open ports: 22, 8000---### 13.2 IAM roleAttach an IAM role to the EC2 instance with S3 access.Example policy:```json{  "Version": "2012-10-17",  "Statement": [    {      "Effect": "Allow",      "Action": ["s3:PutObject", "s3:GetObject"],      "Resource": "arn:aws:s3:::labguard-proofs-awt/*"    }  ]}```---### 13.3 S3 bucket- Name: labguard-proofs-awt- Same region as EC2- Block all public access- Access images only via presigned URLs---## 14. Environment variables```bashS3_BUCKET_NAME=labguard-proofs-awtAWS_REGION=eu-north-1ATOMWALK_BASE_URL=https://crm.atomwalk.com/lab_apiATOMWALK_DB_NAME=LEM_002ATOMWALK_DEVICE_NO=123ATOMWALK_SECRET_KEY=xxxxxxxx```---## 15. Python setup```bashsudo apt install python3.10 python3.10-venvpython3.10 -m venv venvsource venv/bin/activatepip install -r requirements.txt```---## 16. systemd production setupCreate /etc/systemd/system/labguard.service```ini[Unit]Description=LabGuard BackendAfter=network.target[Service]User=ubuntuWorkingDirectory=/home/ubuntu/backendEnvironment=PYTHONUNBUFFERED=1Environment=S3_BUCKET_NAME=labguard-proofs-awtEnvironment=AWS_REGION=eu-north-1Environment=ATOMWALK_BASE_URL=https://crm.atomwalk.com/lab_apiEnvironment=ATOMWALK_DB_NAME=LEM_002Environment=ATOMWALK_DEVICE_NO=123Environment=ATOMWALK_SECRET_KEY=xxxxxxxxExecStart=/home/ubuntu/venv/bin/python -m uvicorn app.main:app \  --host 0.0.0.0 \  --port 8000 \  --workers 1Restart=alwaysRestartSec=5[Install]WantedBy=multi-user.target```Enable and start the service:```bashsudo systemctl daemon-reloadsudo systemctl enable labguardsudo systemctl start labguard```View logs:```bashjournalctl -u labguard -f```---## 17. Deployment checklist- EC2 instance running- IAM role attached- S3 bucket created- Model files present- Environment variables set- systemd service running- SDK polling works- UI shows PPE breakdown and snapshot